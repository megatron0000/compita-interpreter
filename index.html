<!DOCTYPE html>
<html ng-app="CompilerApp">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Compiladores 2019 - Lab 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/index.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/codemirror.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/lint.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/jquery.numberedtextarea.css" />

  <style>
    .CodeMirror {
      border: 1px solid #eee;
      height: auto;
    }

    .bordered {
      border: 1px solid black;
      padding: 10px;
    }
  </style>
</head>

<body>
  <h1>Taste the COMPITA language <br><small style="color: gray">everything updates automatically, except the "code
      execution" section</small></h1>
  <h3>Type only at the "source code" section</h3>
  <div ng-controller="Lab3Controller" style="display: flex; flex-direction: row; flex-flow: row wrap;">
    <div style="flex-basis: 1; margin:10px;" class="bordered">
      <h2>Source Code</h2>
      <p>Write your code here, and all else ensues (except code execution, for which you must click "execute" button on
        the execution section)</p>
      <textarea ng-change="onSourceChange($event)" ng-model="sentence_input"
        style="padding: 10px; width: 100%; max-height: 400px; overflow-y: auto; font-family: monospace !important; font-size: 10px !important"
        id="lab3-source-code">
                    </textarea>
      <p>If you want to code nothing, here go some default programs:</p>
      <ul>
        <li ng-repeat="prog in samplePrograms">
          <button ng-click="downloadSample(prog)" style="padding: 5px;">{{prog}}</button>
        </li>
      </ul>
    </div>
    <div style="flex-basis: 1; flex-grow: 1; margin: 10px;" class="bordered">
      <h2>Pretty-printed code (or an error)</h2>
      <div style="overflow-y: auto; max-height:400px; font-size: 10px;"><textarea id="lab3-pretty-code"
          readonly=true></textarea></div>
    </div>
    <div style="flex-basis: 1; flex-grow: 1; margin: 10px;" class="bordered">
      <h2>Abstract syntax tree</h2>
      <div style="max-height: 400px; overflow: auto; font-size:10px">
        <pre id="ast"></pre>
      </div>
    </div>
    <div style="flex-basis: 1; flex-grow: 1; margin: 10px;" class="bordered">
      <h2>Symbol table</h2>
      <div style="max-height: 400px; overflow-y:auto;">
        <ul>
          <li ng-repeat="entry in symbols">
            <h3>Scope:
              {{entry.scope.kind === 'global' ? 'global' : ('of function ' + (entry.scope.function.name || 'main'))}}
            </h3>
            <ul>
              <li ng-repeat="symbol in entry.symbolNames">
                {{symbol}}
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div style="flex-basis: 1; flex-grow: 1; margin: 10px;" class="bordered">
      <h2>Semantical Errors</h2>
      <p>
        These errors are easier to see at the pretty-printed code. But, if you want them listed down, here they go:
      </p>
      <div style="max-height: 400px; overflow-y: auto;">
        <ol>
          <li ng-repeat="error in semanticalErrors">
            {{error.message}}
          </li>
        </ol>
      </div>
      <p ng-show="!semanticalErrors">
        Nenhum =)
      </p>
    </div>
    <div style="flex-basis: 1; flex-grow: 1; margin: 10px;" class="bordered">
      <h2>"Machine" instructions</h2>
      <div style="max-height: 400px; overflow-y: auto;">
        <table ng-show="assembly" style="width: 100%">
          <thead>
            <th>
              Address
            </th>
            <th>
              Instruction
            </th>
          </thead>
          <tbody>
            <tr ng-repeat="line in assembly">
              <td style="text-align: center">
                <pre style="margin: 0;">{{line.address}}</pre>
              </td>
              <td>
                <pre style="margin: 0">    {{line.text}}</pre>
              </td>
            </tr>
          </tbody>
        </table>
        <p ng-show="!assembly">
          Correct errors first !
        </p>
      </div>
    </div>
    <div style="flex-basis: 1; flex-grow: 1; margin: 10px;" class="bordered">
      <h2>Code (instruction) execution</h2>
      <h3>Execute</h3>
      <div style="overflow: hidden">
        <button style="display: block; width: 100%; padding: 10px; overflow: hidden;" ng-disabled="!assembly"
          ng-click="runCode()">
          {{!assembly ? 'Cannot execute (no valid code)' : !finished ? 'Stop' : 'Execute'}}
        </button>
      </div>
      <h3>Send input (stdin) to the executing code</h3>
      <div>
        <textarea ng-change="onStdinChange($event)" ng-model="remote_stdin"
          style="padding: 10px; width: 100%;box-sizing: border-box ; max-height: 300px; overflow-y: auto"
          id="remote-stdin">
                    </textarea>
        <button style="display: block; width: 100%; padding: 10px; overflow: hidden;" ng-disabled="finished"
          ng-click="sendStdin()">
          {{finished ? 'Cannot send (no code is executing now)' : 'Send (do not forget to type \\n, if you want them !)'}}
        </button>
      </div>
      <h3>Terminal view (stdin you send, and output the code produces)</h3>
      <div style="display: table; table-layout: fixed; width:100%;">
        <pre style="display: table-cell; overflow:auto">{{output}}</pre>
      </div>
    </div>
  </div>

  <script src="build/bundle.js"></script>
  <script src="js/codemirror.js"></script>
  <script src="js/lint.js"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.numberedtextarea.js"></script>

  <script>

    $('#lab3-source-code').numberedtextarea()
    $('#remote-stdin').numberedtextarea()


    var editor = CodeMirror.fromTextArea(document.getElementById('lab3-pretty-code'), {
      lineNumbers: true,
      viewportMargin: Infinity,
      gutters: ["CodeMirror-lint-markers"],
      mode: 'mymode',
      lint: {
        getAnnotations: text => {
          if (!window.getSemanticErrors) {
            return
          }
          const errors = window.getSemanticErrors()
          return errors.map(error => ({
            message: error.message,
            severity: 'error',
            from: CodeMirror.Pos(error.begin.line - 1, error.begin.col),
            to: CodeMirror.Pos(error.end.line - 1, error.end.col),
          }))
        }
      }
    });


    window.addEventListener('prettyCodeChanged', event => {
      editor.setValue(event.prettyCode)
    })
  </script>
</body>

</html>